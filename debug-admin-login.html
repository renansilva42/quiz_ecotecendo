<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Admin Login - Quiz das √Åguas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            background: #f9fafb;
        }
        .debug-section h3 {
            color: #374151;
            margin-top: 0;
        }
        .button {
            background: #0891b2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #0e7490;
        }
        .button.danger {
            background: #dc2626;
        }
        .button.danger:hover {
            background: #b91c1c;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .code {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            overflow-x: auto;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Debug Admin Login</h1>
            <p>Diagn√≥stico do problema de login do administrador</p>
        </div>

        <div class="debug-section">
            <h3>üìã Configura√ß√£o do Supabase</h3>
            <div class="input-group">
                <label for="supabaseUrl">Supabase URL:</label>
                <input type="text" id="supabaseUrl" placeholder="https://seu-projeto.supabase.co">
            </div>
            <div class="input-group">
                <label for="supabaseKey">Supabase Anon Key:</label>
                <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>
            <button class="button" onclick="testConnection()">Testar Conex√£o</button>
            <div id="connectionStatus"></div>
        </div>

        <div class="debug-section">
            <h3>üë§ Verificar Usu√°rio Admin</h3>
            <button class="button" onclick="checkAdminUser()">Verificar se Admin Existe</button>
            <button class="button" onclick="listAllUsers()">Listar Todos os Usu√°rios</button>
            <div id="userStatus"></div>
        </div>

        <div class="debug-section">
            <h3>üîê Testar Login</h3>
            <div class="input-group">
                <label for="testEmail">Email:</label>
                <input type="email" id="testEmail" value="admin@ecotecendo.com.br">
            </div>
            <div class="input-group">
                <label for="testPassword">Senha:</label>
                <input type="password" id="testPassword" value="admin123456">
            </div>
            <button class="button" onclick="testLogin()">Testar Login</button>
            <div id="loginStatus"></div>
        </div>

        <div class="debug-section">
            <h3>üõ†Ô∏è Criar Usu√°rio Admin</h3>
            <button class="button" onclick="createAdminUser()">Criar Usu√°rio Admin</button>
            <button class="button danger" onclick="deleteAdminUser()">Deletar Usu√°rio Admin</button>
            <div id="createStatus"></div>
        </div>

        <div class="debug-section">
            <h3>üìä Status do Sistema</h3>
            <div id="systemStatus">
                <div class="status info">Configure as credenciais do Supabase e execute os testes</div>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;

        // Inicializar Supabase
        async function initSupabase() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;
            
            if (!url || !key) {
                showStatus('systemStatus', 'Configure as credenciais do Supabase primeiro', 'error');
                return null;
            }
            
            try {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                supabase = createClient(url, key);
                return supabase;
            } catch (error) {
                showStatus('systemStatus', 'Erro ao carregar Supabase: ' + error.message, 'error');
                return null;
            }
        }

        // Mostrar status
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // Testar conex√£o
        async function testConnection() {
            showStatus('connectionStatus', 'Testando conex√£o...', 'info');
            
            try {
                const client = await initSupabase();
                if (!client) return;
                
                const { data, error } = await client
                    .from('water_quiz_settings')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    showStatus('connectionStatus', 'Erro na conex√£o: ' + error.message, 'error');
                } else {
                    showStatus('connectionStatus', '‚úÖ Conex√£o estabelecida com sucesso!', 'success');
                }
            } catch (error) {
                showStatus('connectionStatus', 'Erro inesperado: ' + error.message, 'error');
            }
        }

        // Verificar usu√°rio admin
        async function checkAdminUser() {
            showStatus('userStatus', 'Verificando usu√°rio admin...', 'info');
            
            try {
                const client = await initSupabase();
                if (!client) return;
                
                const { data, error } = await client.auth.admin.listUsers();
                
                if (error) {
                    showStatus('userStatus', 'Erro ao listar usu√°rios: ' + error.message, 'error');
                } else {
                    const adminUser = data.users.find(user => user.email === 'admin@ecotecendo.com.br');
                    if (adminUser) {
                        showStatus('userStatus', `‚úÖ Usu√°rio admin encontrado!<br>
                            Email: ${adminUser.email}<br>
                            ID: ${adminUser.id}<br>
                            Criado em: ${new Date(adminUser.created_at).toLocaleString()}<br>
                            Email confirmado: ${adminUser.email_confirmed_at ? 'Sim' : 'N√£o'}`, 'success');
                    } else {
                        showStatus('userStatus', '‚ùå Usu√°rio admin n√£o encontrado', 'error');
                    }
                }
            } catch (error) {
                showStatus('userStatus', 'Erro inesperado: ' + error.message, 'error');
            }
        }

        // Listar todos os usu√°rios
        async function listAllUsers() {
            showStatus('userStatus', 'Listando todos os usu√°rios...', 'info');
            
            try {
                const client = await initSupabase();
                if (!client) return;
                
                const { data, error } = await client.auth.admin.listUsers();
                
                if (error) {
                    showStatus('userStatus', 'Erro ao listar usu√°rios: ' + error.message, 'error');
                } else {
                    let usersList = 'Usu√°rios encontrados:<br><br>';
                    data.users.forEach((user, index) => {
                        usersList += `${index + 1}. ${user.email} (ID: ${user.id})<br>`;
                    });
                    showStatus('userStatus', usersList, 'info');
                }
            } catch (error) {
                showStatus('userStatus', 'Erro inesperado: ' + error.message, 'error');
            }
        }

        // Testar login
        async function testLogin() {
            showStatus('loginStatus', 'Testando login...', 'info');
            
            try {
                const client = await initSupabase();
                if (!client) return;
                
                const email = document.getElementById('testEmail').value;
                const password = document.getElementById('testPassword').value;
                
                const { data, error } = await client.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    showStatus('loginStatus', `‚ùå Erro no login: ${error.message}<br>
                        C√≥digo: ${error.status}<br>
                        Detalhes: ${JSON.stringify(error)}`, 'error');
                } else {
                    showStatus('loginStatus', `‚úÖ Login realizado com sucesso!<br>
                        Usu√°rio: ${data.user.email}<br>
                        ID: ${data.user.id}<br>
                        Sess√£o ativa: ${data.session ? 'Sim' : 'N√£o'}`, 'success');
                }
            } catch (error) {
                showStatus('loginStatus', 'Erro inesperado: ' + error.message, 'error');
            }
        }

        // Criar usu√°rio admin
        async function createAdminUser() {
            showStatus('createStatus', 'Criando usu√°rio admin...', 'info');
            
            try {
                const client = await initSupabase();
                if (!client) return;
                
                const { data, error } = await client.auth.signUp({
                    email: 'admin@ecotecendo.com.br',
                    password: 'admin123456',
                    options: {
                        data: {
                            name: 'Administrador',
                            instagram: 'admin_ecotecendo'
                        }
                    }
                });
                
                if (error) {
                    showStatus('createStatus', `‚ùå Erro ao criar usu√°rio: ${error.message}<br>
                        C√≥digo: ${error.status}<br>
                        Detalhes: ${JSON.stringify(error)}`, 'error');
                } else {
                    showStatus('createStatus', `‚úÖ Usu√°rio admin criado com sucesso!<br>
                        Email: ${data.user?.email}<br>
                        ID: ${data.user?.id}<br>
                        Confirma√ß√£o necess√°ria: ${data.user?.email_confirmed_at ? 'N√£o' : 'Sim'}`, 'success');
                }
            } catch (error) {
                showStatus('createStatus', 'Erro inesperado: ' + error.message, 'error');
            }
        }

        // Deletar usu√°rio admin
        async function deleteAdminUser() {
            if (!confirm('Tem certeza que deseja deletar o usu√°rio admin? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            showStatus('createStatus', 'Deletando usu√°rio admin...', 'info');
            
            try {
                const client = await initSupabase();
                if (!client) return;
                
                // Primeiro, listar usu√°rios para encontrar o ID
                const { data: usersData, error: listError } = await client.auth.admin.listUsers();
                
                if (listError) {
                    showStatus('createStatus', 'Erro ao listar usu√°rios: ' + listError.message, 'error');
                    return;
                }
                
                const adminUser = usersData.users.find(user => user.email === 'admin@ecotecendo.com.br');
                
                if (!adminUser) {
                    showStatus('createStatus', 'Usu√°rio admin n√£o encontrado', 'error');
                    return;
                }
                
                const { error } = await client.auth.admin.deleteUser(adminUser.id);
                
                if (error) {
                    showStatus('createStatus', 'Erro ao deletar usu√°rio: ' + error.message, 'error');
                } else {
                    showStatus('createStatus', '‚úÖ Usu√°rio admin deletado com sucesso!', 'success');
                }
            } catch (error) {
                showStatus('createStatus', 'Erro inesperado: ' + error.message, 'error');
            }
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('systemStatus', 'Configure as credenciais do Supabase e execute os testes para diagnosticar o problema', 'info');
        });
    </script>
</body>
</html>
